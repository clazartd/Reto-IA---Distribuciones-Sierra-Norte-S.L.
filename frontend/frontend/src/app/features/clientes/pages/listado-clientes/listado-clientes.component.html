<div class="clientes-main">
  <div class="clientes-header d-flex align-items-center justify-content-between">
    <h1 class="display-5 fw-bold mb-0">Gestión de Clientes</h1>
    @if (canEdit) {
      <button class="btn btn-primary btn-lg d-flex align-items-center gap-2" (click)="abrirModalNuevoCliente()">
        <span class="fa fa-plus"></span>
        Nuevo Cliente
      </button>
    }
  </div>

  <!-- Card: filtros y búsqueda -->
  <div class="clientes-card card my-4 px-4 py-3">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div class="flex-grow-1">
        <div class="input-group">
          <span class="input-group-text bg-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242 1.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
            </svg>
          </span>
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por nombre, email o teléfono..."
            [(ngModel)]="busqueda"
            (ngModelChange)="filtrarClientes()"
          />
        </div>
      </div>
      <div>
        <select class="form-select" [(ngModel)]="provinciaSeleccionada" (ngModelChange)="filtrarClientes()">
          <option value="">Todas las provincias</option>
          <option *ngFor="let provincia of provinciasDisponibles" [value]="provincia">{{ provincia }}</option>
        </select>
      </div>
    </div>
    <div class="clientes-subtitle mt-2 small text-muted">
      Mostrando {{ clientesFiltrados.length }} de {{ clientes.length }} clientes
    </div>
  </div>

  <!-- Card: listado de clientes -->
  <div class="clientes-card card px-4 py-4">
    <h5 class="fw-bold mb-3">Listado de Clientes</h5>
    <div class="table-responsive">
      <table class="table align-middle mb-0 bg-white">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Teléfono</th>
            <th>Dirección</th>
            <th>Provincia</th>
            @if (canEdit) {
              <th class="text-end">Acciones</th>
            }
          </tr>
        </thead>
        <tbody>
          @if (clientesFiltrados.length > 0) {
            @for (cliente of clientesFiltrados; track cliente.id) {
              <tr>
                <td>{{ cliente.nombre }}</td>
                <td>
                  <span class="fa fa-envelope text-primary me-2"></span>
                  <a [href]="'mailto:' + cliente.email" class="text-decoration-none text-primary">{{ cliente.email || '-' }}</a>
                </td>
                <td>
                  <span class="fa fa-phone text-primary me-2"></span>
                  <a [href]="'tel:' + cliente.telefono" class="text-decoration-none text-primary">{{ cliente.telefono || '-' }}</a>
                </td>
                <td>{{ cliente.direccion || '-' }}</td>
                <td>{{ cliente.provincia || '-' }}</td>
                @if (canEdit) {
                  <td class="text-end">
                    <button class="btn btn-link text-secondary px-2" title="Editar" (click)="onEdit(cliente)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#343A40" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25z"></path>
                        <path d="M20.71 7.04a1.003 1.003 0 0 0 0-1.41l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.83z"></path>
                      </svg>
                    </button>
                    <button class="btn btn-link text-danger px-2" title="Eliminar" (click)="onDelete(cliente)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#e3342f" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="6" width="18" height="13" rx="2" ry="2"></rect>
                        <path d="M8 10v6"></path>
                        <path d="M12 10v6"></path>
                        <path d="M16 10v6"></path>
                        <polyline points="9 6 9 4 15 4 15 6"></polyline>
                        <line x1="1" y1="6" x2="23" y2="6"></line>
                      </svg>
                    </button>
                  </td>
                }
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
    @if (loading) {
      <div class="alert alert-secondary text-center mt-5 mb-0">
        <span class="spinner-border spinner-border-sm me-2"></span>
        Cargando clientes...
      </div>
    }
    @if (!loading && !error && clientesFiltrados.length === 0) {
      <div class="alert alert-info text-center mt-5 mb-0">
        No hay clientes registrados aún.
      </div>
    }
    @if (!loading && error) {
      <div class="alert alert-danger text-center mt-5 mb-0">
        {{ error }}
      </div>
    }
  </div>
</div>

<!-- Modal: Nuevo Cliente -->
@if (mostrarNuevoClienteModal) {
  <app-nuevo-cliente (cerrar)="cerrarModalNuevoCliente()"></app-nuevo-cliente>
}
@if (mostrarEditarClienteModal && clienteAEditar) {
  <app-nuevo-cliente [cliente]="clienteAEditar" [modoEdicion]="true" (cerrar)="cerrarModalEditarCliente()"></app-nuevo-cliente>
}
<!-- Modal: Eliminar Cliente -->
<app-confirm-modal
  [show]="mostrarConfirmModal"
  [title]="'Eliminar cliente'"
  [message]="'¿Seguro que deseas eliminar a ' + (clienteAEliminar?.nombre || '') + '?'"
  (confirmed)="confirmarEliminacion()"
  (cancelled)="cancelarEliminacion()">
</app-confirm-modal>
