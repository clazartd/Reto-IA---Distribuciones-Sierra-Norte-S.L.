<div class="bg-white rounded shadow p-4">
  <h2 class="mb-4">Listado de pedidos</h2>

  @if (esComercial) {
    <div class="mb-3">
      <app-agregar-pedido-button (agregarPedido)="abrirNuevoPedidoModal()"></app-agregar-pedido-button>
    </div>
  }

  <form class="row g-3 mb-3" (ngSubmit)="filtrar()">
    <div class="col-md-4">
      <label class="form-label">Estado</label>
      <select class="form-select" [(ngModel)]="filtroEstado" name="estado" (change)="filtrar()">
        <option value="">Todos</option>
        @for (estado of estadosUnicos; track estado) {
          <option [ngValue]="estado">{{ estado }}</option>
        }
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha prevista</label>
      <input type="date" class="form-control" [(ngModel)]="filtroFecha" name="fechaEntrega" (change)="filtrar()" />
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button type="button" class="btn btn-outline-secondary me-2" (click)="filtroEstado=''; filtroFecha=''; filtrar()">
        Limpiar filtros
      </button>
    </div>
  </form>

  <app-nuevo-pedido #nuevoPedidoModal (closed)="nuevoPedidoModalClosed()"></app-nuevo-pedido>
  <app-editar-pedido #editarPedidoModal (saved)="onPedidoEdit($event)" (closed)="selectedPedidoToEdit=null"></app-editar-pedido>

  <app-confirm-modal
    [show]="showCancelConfirm && selectedPedidoToCancel !== null"
    [title]="'Cancelar pedido'"
    [message]="'¿Estás seguro de que deseas cancelar el pedido <b>#' + selectedPedidoToCancel?.id + '</b> de <b>' + selectedPedidoToCancel?.cliente + '</b>?'"
    [cancelText]="'No, volver'"
    [confirmText]="'Sí, cancelar'"
    (confirmed)="confirmarCancelarPedido()"
    (cancelled)="cancelarCancelarPedido()"
  ></app-confirm-modal>

  @if (loading) {
    <div class="alert alert-info">Cargando pedidos...</div>
  }
  @if (error) {
    <div class="alert alert-danger">{{ error }}</div>
  }
  @if (!loading && !error && filteredPedidos.length === 0) {
    <div class="alert alert-warning">No hay pedidos coincidentes.</div>
  }

  @if (!loading && !error && filteredPedidos.length > 0) {
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Estado</th>
            <th>Fecha prevista</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (pedido of filteredPedidos; track pedido.id) {
            <tr>
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.cliente }}</td>
              <td>
                <span [class]="pedido.estado === 'cancelado' ? 'text-danger' : pedido.estado === 'registrado' ? 'text-primary' : 'text-success'">
                  {{ pedido.estado }}
                </span>
              </td>
              <td>{{ pedido.fechaPrevistaEntrega }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-2" type="button" (click)="abrirEditarPedidoModal(pedido)" aria-label="Editar">
                  <i class="bi bi-pencil" aria-hidden="true"></i>
                </button>
                @if (pedido.estado !== 'cancelado') {
                  <button
                    class="btn btn-sm btn-outline-danger"
                    type="button"
                    (click)="abrirCancelarPedidoConfirm(pedido)"
                    aria-label="Cancelar"
                  >
                    <i class="bi bi-x-circle" aria-hidden="true"></i>
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
